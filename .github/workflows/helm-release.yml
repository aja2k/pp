name: Release Helm Charts

# GitHub Actions 권한 설정
permissions:
  contents: write      # helm-docs push를 위한 쓰기 권한 필요
  pages: write        # GitHub Pages 배포 권한
  id-token: write     # OIDC 토큰 생성 권한
  pull-requests: write # PR 생성 및 수정 권한 (필요시)
  issues: write       # 이슈 생성 및 수정 권한 (필요시)
  packages: write     # 패키지 업로드 권한
  deployments: write  # 배포 권한

on:
  push:
    branches: [ "main" ]
    paths:
      - 'projects/*/example/helmcharts/**'
      - '.github/workflows/helm-release.yml'
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Install Helm
        uses: azure/setup-helm@v3

      - name: Install helm-docs
        run: |
          wget https://github.com/norwoodj/helm-docs/releases/download/v1.11.0/helm-docs_1.11.0_Linux_x86_64.tar.gz
          tar -xvf helm-docs_1.11.0_Linux_x86_64.tar.gz
          sudo mv helm-docs /usr/local/bin/helm-docs

      - name: Generate Helm Docs
        run: |
          WORKSPACE="${GITHUB_WORKSPACE}"
          
          # 각 프로젝트 순회
          for project in ${WORKSPACE}/projects/*; do
            if [ -d "$project/example/helmcharts" ]; then
              cd $project/example/helmcharts
              
              # 각 환경별 문서 생성
              for env in dev stg prd; do
                if [ -d "$env" ]; then
                  for chart in $env/*; do
                    if [ -d "$chart" ]; then
                      echo "Generating docs for $chart"
                      helm-docs -c "$chart"
                    fi
                  done
                fi
              done
              
              cd ${WORKSPACE}
            fi
          done

      - name: Commit and Push Helm Docs
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # 변경된 문서 확인 및 커밋
          if [[ -n "$(git status --porcelain)" ]]; then
            echo "Changes detected in helm docs"
            git add projects/*/example/helmcharts/**/README.md
            git commit -m "Update helm documentation"
            git push
          else
            echo "No changes in helm docs"
          fi

      - name: Create releases directories
        run: |
          mkdir -p helm-repo

      - name: Package Helm Charts
        run: |
          WORKSPACE="${GITHUB_WORKSPACE}"
          
          # 각 프로젝트 순회
          for project in ${WORKSPACE}/projects/*; do
            if [ -d "$project/example/helmcharts" ]; then
              project_name=$(basename $project)
              echo "Processing project: $project_name"
              
              # 환경별 디렉토리 생성
              mkdir -p helm-repo/${project_name}/{dev,stg,prd}
              
              cd $project/example/helmcharts
              
              # DEV 환경 차트 패키징
              if [ -d "dev" ]; then
                for dir in dev/*; do
                  if [ -d "$dir" ] && [ -f "$dir/Chart.yaml" ]; then
                    echo "Packaging DEV chart: $dir"
                    helm package "$dir" --destination ${WORKSPACE}/helm-repo/${project_name}/dev/
                  else
                    echo "Skipping non-helm chart directory: $dir"
                  fi
                done
              fi
              
              # STG 환경 차트 패키징
              if [ -d "stg" ]; then
                for dir in stg/*; do
                  if [ -d "$dir" ] && [ -f "$dir/Chart.yaml" ]; then
                    echo "Packaging STG chart: $dir"
                    helm package "$dir" --destination ${WORKSPACE}/helm-repo/${project_name}/stg/
                  else
                    echo "Skipping non-helm chart directory: $dir"
                  fi
                done
              fi
              
              # PRD 환경 차트 패키징
              if [ -d "prd" ]; then
                for dir in prd/*; do
                  if [ -d "$dir" ] && [ -f "$dir/Chart.yaml" ]; then
                    echo "Packaging PRD chart: $dir"
                    helm package "$dir" --destination ${WORKSPACE}/helm-repo/${project_name}/prd/
                  else
                    echo "Skipping non-helm chart directory: $dir"
                  fi
                done
              fi
              
              cd ${WORKSPACE}
            fi
          done

      - name: Create index.yaml files
        run: |
          # 각 프로젝트의 환경별 index.yaml 생성
          for project_dir in helm-repo/*; do
            if [ -d "$project_dir" ]; then
              project_name=$(basename $project_dir)
              
              # DEV 환경 index 생성
              if [ -d "$project_dir/dev" ]; then
                helm repo index --url https://aja2k.github.io/pp/helm-repo/${project_name}/dev/ $project_dir/dev/
              fi
              
              # STG 환경 index 생성
              if [ -d "$project_dir/stg" ]; then
                helm repo index --url https://aja2k.github.io/pp/helm-repo/${project_name}/stg/ $project_dir/stg/
              fi
              
              # PRD 환경 index 생성
              if [ -d "$project_dir/prd" ]; then
                helm repo index --url https://aja2k.github.io/pp/helm-repo/${project_name}/prd/ $project_dir/prd/
              fi
            fi
          done

      - name: Debug directory structure
        run: |
          echo "Contents of helm-repo/:"
          ls -R helm-repo/
          
          echo "Current working directory:"
          pwd

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: helm-repo/

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
